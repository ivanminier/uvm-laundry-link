<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UVM LaundryLink</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide-react.js"></script>

    <style>
        /* Custom UVM Font - Inter is a good fallback provided by Tailwind */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* UVM Colors (can be used in inline styles if needed, but Tailwind classes preferred) */
        :root {
            --uvm-green: #154734;
            --uvm-gold: #fdb515;
        }
        .bg-uvm-green { background-color: var(--uvm-green); }
        .text-uvm-green { color: var(--uvm-green); }
        .border-uvm-green { border-color: var(--uvm-green); }
        .bg-uvm-gold { background-color: var(--uvm-gold); }
        .text-uvm-gold { color: var(--uvm-gold); }
        .border-uvm-gold { border-color: var(--uvm-gold); }
        .fill-uvm-gold { fill: var(--uvm-gold); } /* For SVG fill */


        /* Animation Styles (moved from inline script for better organization) */
        @keyframes slideInFromLeft {
          from { transform: translateX(-20%); opacity: 0.5; } 
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideInFromRight {
          from { transform: translateX(20%); opacity: 0.5; } 
          to { transform: translateX(0); opacity: 1; }
        }
        .animate-slideInFromLeft { animation: slideInFromLeft 0.35s ease-out forwards; } 
        .animate-slideInFromRight { animation: slideInFromRight 0.35s ease-out forwards; }

        /* Ensure html and body take full height for sticky footer if needed, and smooth scrolling */
        html, body {
            height: 100%;
            scroll-behavior: smooth;
        }
        #root {
            display: flex;
            flex-direction: column;
            min-height: 100vh; /* Ensure root takes full viewport height */
        }
        main {
            flex-grow: 1; /* Allows main content to expand and push footer down */
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Ensure Lucide icons are available globally if not using direct imports
        // For UMD, they are usually on `lucide-react.IconName`
        const { Zap, CheckCircle, XCircle, AlertTriangle, Clock, RefreshCw, Sun, Moon, Info, Settings, Star, ArrowLeft, Filter, ExternalLink, Droplet, Wind, MessageCircle, Smartphone, Save, Home: HomeIconLucide } = lucideReact; // Renamed Home to HomeIconLucide to avoid conflict with component

        // UVM Catamount Green: #154734
        const UVM_GREEN = '#154734';
        const UVM_GOLD = '#fdb515'; 
        const UVM_LOGO_URL = 'https://i.imgur.com/kvyrGbL.png'; 

        // Helper function to get status color and icon
        const getStatusDetails = (status) => {
          const rawStatus = String(status || 'Unknown').trim();
          const lowerStatus = rawStatus.toLowerCase();
          let actualStatusOutput = "Unknown"; 
          let iconElement = <AlertTriangle size={16} className="mr-1.5 flex-shrink-0" />; 
          let textColor = 'text-gray-700 dark:text-gray-400';
          let bgColor = 'bg-gray-100 dark:bg-gray-900';

          if (lowerStatus.includes('available')) {
            actualStatusOutput = 'Available';
            iconElement = <CheckCircle size={16} className="mr-1.5 flex-shrink-0" />;
            textColor = 'text-green-700 dark:text-green-400';
            bgColor = 'bg-green-100 dark:bg-green-900';
          } else if (lowerStatus.includes('out of order') || lowerStatus.includes('service') || lowerStatus.includes('offline')) {
            actualStatusOutput = 'Out of Order';
            iconElement = <XCircle size={16} className="mr-1.5 flex-shrink-0" />;
            textColor = 'text-red-700 dark:text-red-400';
            bgColor = 'bg-red-100 dark:bg-red-900';
          } else if (lowerStatus.includes('eoc') || lowerStatus.includes('cycle finished') || lowerStatus.includes('complete') || lowerStatus.includes('cycle complete')) {
            actualStatusOutput = 'Cycle Finished';
            iconElement = <CheckCircle size={16} className="mr-1.5 flex-shrink-0" />;
            textColor = 'text-teal-700 dark:text-teal-400';
            bgColor = 'bg-teal-100 dark:bg-teal-900';
          } else { 
            const timeMatch = rawStatus.match(/(\d+)\s*min/i); 
            if (timeMatch && parseInt(timeMatch[1], 10) > 0) {
              if (parseInt(timeMatch[1], 10) <= 5) {
                actualStatusOutput = 'Finishing Soon';
                iconElement = <Clock size={16} className="mr-1.5 flex-shrink-0" />;
                textColor = 'text-yellow-700 dark:text-yellow-400';
                bgColor = 'bg-yellow-100 dark:bg-yellow-900';
              } else {
                actualStatusOutput = 'In Use'; 
                iconElement = <Zap size={16} className="mr-1.5 flex-shrink-0" />;
                textColor = 'text-blue-700 dark:text-blue-400';
                bgColor = 'bg-blue-100 dark:bg-blue-900';
              }
            } else if (lowerStatus.includes('in use')) { 
                actualStatusOutput = 'In Use'; 
                iconElement = <Zap size={16} className="mr-1.5 flex-shrink-0" />;
                textColor = 'text-blue-700 dark:text-blue-400';
                bgColor = 'bg-blue-100 dark:bg-blue-900';
            } else if (rawStatus && rawStatus !== 'Unknown') { 
                actualStatusOutput = rawStatus.replace(/\b\w/g, l => l.toUpperCase());
            } else {
                actualStatusOutput = "Status Unknown"; 
            }
          }
          return { icon: iconElement, textColor, bgColor, actualStatus: String(actualStatusOutput) }; 
        };

        const formatTime = (minutes) => {
          if (!minutes || minutes <= 0) return ''; 
          const h = Math.floor(minutes / 60);
          const m = minutes % 60;
          return `${h > 0 ? `${h}h ` : ''}${m}m`;
        };

        const MachineCard = React.memo(({ machine, onSetUpSmsAlert, isSmsAlertSet }) => { 
          const { icon: statusIcon, textColor, bgColor, actualStatus } = getStatusDetails(machine.status);
          const canSetUpAlert = actualStatus === 'In Use' || actualStatus === 'Finishing Soon';
          const MachineTypeSpecificIcon = machine.type === 'Washer' ? Droplet : Wind;

          const formattedTimeRemaining = formatTime(machine.timeRemaining);
          const badgeTextDisplay = (actualStatus === 'In Use' || actualStatus === 'Finishing Soon') && formattedTimeRemaining ? formattedTimeRemaining : actualStatus;

          return (
            <div className={`rounded-xl shadow-lg p-4 transition-all duration-300 ease-in-out hover:shadow-2xl bg-white dark:bg-slate-800 border border-gray-200 dark:border-slate-700 flex flex-col min-h-[230px] justify-between`}>
              <div>
                <div className="flex items-center justify-between mb-2"> 
                  <h3 className="text-base sm:text-lg font-semibold text-gray-800 dark:text-white truncate" title={String(machine.machineName || `Machine ${machine.id}`)}>
                    {String(machine.machineName || `Machine ${machine.id}`)}
                  </h3> 
                  <div className={`px-2.5 py-1 rounded-full text-xs font-medium flex items-center flex-shrink-0 ${bgColor} ${textColor}`}> 
                    {statusIcon} 
                    <span className="truncate">{String(badgeTextDisplay)}</span>
                  </div> 
                </div>
                <div className="mb-3 flex items-center text-sm text-gray-500 dark:text-slate-400"> 
                  <MachineTypeSpecificIcon size={16} className="mr-2 text-slate-500 dark:text-slate-400 flex-shrink-0" /> 
                  <span>{String(machine.type || 'N/A')} - {String(machine.size || 'N/A')}</span> 
                </div>
              </div>
              
              <div className="flex-grow flex flex-col items-center justify-center my-2 text-center">
                <p className={`text-xl font-semibold ${textColor}`}>
                    {String(actualStatus)}
                </p>
                {(machine.timeRemaining > 0 && (actualStatus === 'In Use' || actualStatus === 'Finishing Soon')) && (
                    <p className="text-4xl font-bold mt-1" style={{color: UVM_GREEN}}>{formattedTimeRemaining}</p>
                )}
              </div>

              <div className="mt-auto space-y-2 pt-3 border-t border-gray-100 dark:border-slate-700"> 
                 {canSetUpAlert ? (
                    isSmsAlertSet ? (
                      <div className="w-full font-semibold py-2.5 px-4 rounded-lg text-sm flex items-center justify-center bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300">
                        <CheckCircle size={16} className="mr-2"/> 
                        SMS Alert Set
                      </div>
                    ) : (
                      <button 
                        onClick={() => onSetUpSmsAlert(machine)}
                        className="w-full font-semibold py-2.5 px-4 rounded-lg transition-all duration-200 text-sm flex items-center justify-center text-white focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-uvm-gold"
                        style={{backgroundColor: UVM_GREEN}}
                        onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#0f3927'} 
                        onMouseOut={(e) => e.currentTarget.style.backgroundColor = UVM_GREEN}
                      >
                        <MessageCircle size={16} className="mr-2" /> 
                        Set SMS Alert
                      </button>
                    )
                 ) : (
                    <div className="h-[2.75rem]"></div> 
                 )}
              </div>
            </div>
          );
        });

        const RoomCard = React.memo(({ room, onSelectRoom, isFavorite, onToggleFavorite }) => ( 
            <div 
                onClick={() => onSelectRoom(room.id)} 
                className="rounded-xl shadow-lg p-6 flex flex-col justify-between hover:shadow-2xl transition-all duration-300 cursor-pointer h-full min-h-[160px] group" 
                style={{ backgroundColor: UVM_GREEN }} 
            > 
                <div> 
                    <h3 className="text-xl sm:text-2xl font-semibold mb-3 text-white group-hover:text-uvm-gold transition-colors">{String(room.name)}</h3> 
                </div> 
                <div className="flex items-center justify-end mt-auto pt-4"> 
                    <button 
                        onClick={(e) => { e.stopPropagation(); onToggleFavorite(room.id); }} 
                        title={isFavorite ? "Remove from Favorites" : "Add to Favorites"} 
                        className="p-2 rounded-full hover:bg-white/20 transition-colors"
                    > 
                        <Star size={24} className={`transition-colors ${isFavorite ? 'text-uvm-gold fill-uvm-gold' : 'text-white/70 group-hover:text-white'}`} /> {/* Used text-uvm-gold and fill-uvm-gold */}
                    </button> 
                </div> 
            </div> 
        ));


        // Main App Component
        const App = () => {
          const [currentView, setCurrentView] = React.useState('home'); 
          const [animationDirection, setAnimationDirection] = React.useState(''); 
          const [laundryRooms, setLaundryRooms] = React.useState([]);
          const [selectedRoomId, setSelectedRoomId] = React.useState('');
          const [machines, setMachines] = React.useState([]);
          const [isLoadingRooms, setIsLoadingRooms] = React.useState(true);
          const [isLoadingMachines, setIsLoadingMachines] = React.useState(false); 
          const [isBackgroundRefreshing, setIsBackgroundRefreshing] = React.useState(false); 
          const [searchTerm, setSearchTerm] = React.useState(''); 
          const [filterStatus, setFilterStatus] = React.useState('All'); 
          const [isDarkMode, setIsDarkMode] = React.useState(false); 
          const [lastUpdated, setLastUpdated] = React.useState(null);
          const [error, setError] = React.useState(null);
          const [favorites, setFavorites] = React.useState(() => { try { const sf = localStorage.getItem('uvmLaundryFavorites'); return sf ? JSON.parse(sf) : []; } catch (e) { console.error("Error parsing favorites from localStorage", e); return []; } });
          const [showOnlyFavorites, setShowOnlyFavorites] = React.useState(false);
          const [showSmsModal, setShowSmsModal] = React.useState(false);
          const [smsMachine, setSmsMachine] = React.useState(null);
          const [phoneNumber, setPhoneNumber] = React.useState(() => localStorage.getItem('uvmLaundryPhoneNumber') || ''); 
          const [tempPhoneNumber, setTempPhoneNumber] = React.useState(''); 
          const [smsStatus, setSmsStatus] = React.useState({ message: '', type: '' }); 
          const [smsAlertsSet, setSmsAlertsSet] = React.useState(() => { try { const sa = localStorage.getItem('uvmLaundrySmsAlertsSet'); return sa ? JSON.parse(sa) : []; } catch (e) { return []; } });

          const NGROK_BASE_URL = 'https://7eaa-172-56-118-125.ngrok-free.app'; 

          React.useEffect(() => { const mq = window.matchMedia('(prefers-color-scheme: dark)'); setIsDarkMode(mq.matches); const hc = (e) => setIsDarkMode(e.matches); mq.addEventListener('change', hc); return () => mq.removeEventListener('change', hc); }, []);
          React.useEffect(() => { document.documentElement.classList.toggle('dark', isDarkMode); }, [isDarkMode]);
          React.useEffect(() => { try { localStorage.setItem('uvmLaundryFavorites', JSON.stringify(favorites)); } catch (e) { console.error("Error saving favorites to localStorage", e); } }, [favorites]);
          React.useEffect(() => { localStorage.setItem('uvmLaundryPhoneNumber', phoneNumber); }, [phoneNumber]); 
          React.useEffect(() => { try { localStorage.setItem('uvmLaundrySmsAlertsSet', JSON.stringify(smsAlertsSet));} catch (e) { console.error("Error saving SMS alerts set", e); } }, [smsAlertsSet]);

          const fetchRooms = React.useCallback(async () => { 
            setIsLoadingRooms(true); setError(null); 
            const roomsUrl = `${NGROK_BASE_URL}/rooms`; 
            try { 
              if (NGROK_BASE_URL.includes('YOUR_NGROK_HTTPS_FORWARDING_URL_HERE') || NGROK_BASE_URL.length < 20 || !NGROK_BASE_URL.startsWith('https://')) { 
                  setError("Configuration Error: The NGROK_BASE_URL in the app code needs to be a valid https ngrok forwarding URL from your Raspberry Pi."); 
                  setIsLoadingRooms(false); setLaundryRooms([]); return; 
              }
              const r = await fetch(roomsUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } }); 
              if (!r.ok) { const errorText = await r.text().catch(() => "Could not retrieve error text from server."); throw new Error(`Rooms fetch failed: ${r.status} ${r.statusText}. Server response: ${errorText}. URL: ${roomsUrl}`); }
              const data = await r.json();
              setLaundryRooms(Array.isArray(data) ? data.sort((a,b) => String(a.name).localeCompare(String(b.name))) : []); 
            } catch (e) { 
              console.error("Error fetching room list:", e); 
              setError(`Failed to load room list. ${e.message}. Ensure your Pi server and ngrok are running correctly.`); 
              setLaundryRooms([]); 
            } finally { setIsLoadingRooms(false); } 
          }, [NGROK_BASE_URL]); 

          React.useEffect(() => { fetchRooms(); }, [fetchRooms]);

          const fetchMachineData = React.useCallback(async (roomIdToFetch, isBackground = false) => {
            if (!roomIdToFetch) { setMachines([]); return; }
            if (!isBackground) { setIsLoadingMachines(true); setError(null); } 
            else { setIsBackgroundRefreshing(true); }
            
            const machineDataUrl = `${NGROK_BASE_URL}/laundry-data/${roomIdToFetch}`;
            try {
              const response = await fetch(machineDataUrl, { headers: { 'ngrok-skip-browser-warning': 'true' } });
              if (!response.ok) { const errorText = await response.text().catch(() => "Could not retrieve error text from server."); throw new Error(`Machines fetch failed for ${roomIdToFetch}: ${response.status} ${response.statusText}. Server response: ${errorText}. URL: ${machineDataUrl}`);}
              const jsonData = await response.json();
              const currentMachines = Array.isArray(jsonData) ? jsonData : [];
              setMachines(currentMachines); 
              setLastUpdated(new Date());
              
              setSmsAlertsSet(prevAlerts => {
                let changed = false;
                const updatedAlerts = prevAlerts.filter(alertedMachineId => {
                  const machine = currentMachines.find(m => m.id === alertedMachineId);
                  if (machine) {
                    const { actualStatus } = getStatusDetails(machine.status);
                    if (actualStatus === 'Available' || actualStatus === 'Cycle Finished') {
                      changed = true;
                      return false; 
                    }
                  }
                  return true; 
                });
                return changed ? updatedAlerts : prevAlerts;
              });

              if(isBackground && error) setError(null); 
            } catch (e) { 
                console.error(`Error fetching machines for '${roomIdToFetch}':`, e); 
                const roomName = laundryRooms.find(r=>r.id === roomIdToFetch)?.name || roomIdToFetch;
                if (!isBackground || machines.length === 0) { setError(`Failed to load machines for ${String(roomName)}. ${e.message}.`);}
                if(!isBackground) setMachines([]); 
            } 
            finally { 
              if (!isBackground) setIsLoadingMachines(false); 
              setIsBackgroundRefreshing(false); 
            }
          }, [NGROK_BASE_URL, laundryRooms, machines.length, error, setSmsAlertsSet]); 

          React.useEffect(() => { if (selectedRoomId && currentView === 'roomDetail') fetchMachineData(selectedRoomId, false); }, [selectedRoomId, currentView, fetchMachineData]);
          React.useEffect(() => { 
            if (!selectedRoomId || currentView !== 'roomDetail') return; 
            const intervalId = setInterval(() => fetchMachineData(selectedRoomId, true), 30000); 
            return () => clearInterval(intervalId); 
          }, [selectedRoomId, currentView, fetchMachineData]);
          
          const handleNavigate = (view, direction, roomId = null) => {
            setAnimationDirection(direction);
            if (roomId) setSelectedRoomId(roomId);
            setCurrentView(view);
            setError(null);
            if (view === 'home' || view === 'settings') { // Clear room specific data when going to home or settings
                setSelectedRoomId('');
                setMachines([]);
            }
             if (view === 'settings') { // Pre-fill temp phone number for settings page
                setTempPhoneNumber(phoneNumber);
            }
            setSearchTerm(''); 
            setFilterStatus('All'); 
          };

          const handleRefresh = () => { 
            setError(null); 
            if (selectedRoomId && currentView === 'roomDetail') {
              fetchMachineData(selectedRoomId, false); 
            } else if (currentView === 'home') {
              fetchRooms(); 
            }
            // No specific refresh for settings page needed unless it fetches data
          };
          const toggleFavorite = (roomId) => setFavorites(p => p.includes(roomId) ? p.filter(id => id !== roomId) : [...p, roomId]);
          
          const handleOpenSmsModal = (machine) => { 
            setSmsMachine(machine); 
            setShowSmsModal(true); 
            setSmsStatus({ message: '', type: '' }); 
            setTempPhoneNumber(phoneNumber); 
          };

          const handleSendSmsAlert = async () => {
            const numberToUse = tempPhoneNumber.trim(); 
            if (!smsMachine || !numberToUse || !selectedRoomId) { 
              setSmsStatus({ message: "Error: Phone number and machine selection are required.", type: 'error' }); 
              return; 
            }
            if (!/^\d{10}$/.test(numberToUse)) { 
              setSmsStatus({ message: "Error: Please enter a valid 10-digit phone number.", type: 'error' }); 
              return; 
            }
            
            setSmsStatus({ message: "Sending SMS alert request...", type: 'info' });
            try {
              const response = await fetch(`${NGROK_BASE_URL}/set-sms-alert`, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' }, 
                body: JSON.stringify({ 
                  roomId: selectedRoomId, 
                  machineName: smsMachine.machineName, 
                  phoneNumber: numberToUse
                }) 
              });
              const result = await response.json(); 
              if (response.ok && result.success) { 
                setSmsStatus({ message: result.message || 'SMS alert request submitted successfully!', type: 'success' }); 
                setPhoneNumber(numberToUse); 
                setSmsAlertsSet(prev => [...new Set([...prev, smsMachine.id])]); // Add to set, ensure uniqueness
                setTimeout(() => { 
                    setShowSmsModal(false);
                    setSmsStatus({ message: '', type: '' }); 
                }, 2000); 
              } 
              else { 
                throw new Error(result.error || `Failed to set SMS alert. Server responded with status ${response.status}.`); 
              }
            } catch (err) { 
              console.error("Error setting SMS alert via Pi:", err); 
              setSmsStatus({ message: `Error: ${err.message}. Please ensure the Pi server is running and accessible.`, type: 'error' }); 
            }
          };

          const handleSaveSettingsPhoneNumber = () => {
            if (!/^\d{10}$/.test(tempPhoneNumber.trim()) && tempPhoneNumber.trim() !== '') {
                alert("Please enter a valid 10-digit phone number or leave it blank to clear.");
                return;
            }
            setPhoneNumber(tempPhoneNumber.trim());
            alert(tempPhoneNumber.trim() ? "Phone number saved!" : "Saved phone number cleared.");
          };


          const displayedRooms = showOnlyFavorites ? laundryRooms.filter(room => favorites.includes(room.id)) : laundryRooms;
          
          const roomWashers = machines.filter(m => m.type === 'Washer' && filteredMachines.includes(m));
          const roomDryers = machines.filter(m => m.type === 'Dryer' && filteredMachines.includes(m));

          const totalWashersInRoom = machines.filter(m => m.type === 'Washer').length;
          const availableWashersInRoom = machines.filter(m => getStatusDetails(m.status).actualStatus === 'Available' && m.type === 'Washer').length;
          const totalDryersInRoom = machines.filter(m => m.type === 'Dryer').length;
          const availableDryersInRoom = machines.filter(m => getStatusDetails(m.status).actualStatus === 'Available' && m.type === 'Dryer').length;

          const statusOptions = ['All', 'Available', 'In Use', 'Finishing Soon', 'Cycle Finished', 'Out of Order', 'Unknown'];
          const currentRoomName = laundryRooms.find(room => room.id === selectedRoomId)?.name || (currentView === 'roomDetail' ? "Loading Room..." : (currentView === 'settings' ? 'Settings' : "All Rooms"));
          const currentRoomOfficialUrl = laundryRooms.find(room => room.id === selectedRoomId)?.url;


          return (
            <div className={`min-h-screen ${isDarkMode ? 'bg-slate-900' : 'bg-gray-50'} font-sans transition-colors duration-300`}>
              <header className="sticky top-0 z-40 shadow-lg" style={{ backgroundColor: UVM_GREEN }}> 
                <div className="container mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="flex items-center justify-between h-16">
                    <div 
                      className={`flex items-center ${currentView !== 'home' ? 'cursor-pointer' : ''} group rounded-md p-1 -ml-1 hover:bg-white/10 transition-colors`}
                      onClick={currentView !== 'home' ? () => handleNavigate('home', 'left') : undefined}
                      title={currentView !== 'home' ? "Go to Home" : ""}
                    > 
                      <img src={UVM_LOGO_URL} alt="UVM Logo" className="h-10 w-auto mr-2 sm:mr-3 rounded-sm" onError={(e) => { e.currentTarget.style.display='none'; }}/> 
                      <h1 className="text-xl md:text-2xl font-bold text-white tracking-tight group-hover:text-uvm-gold transition-colors">{currentView === 'home' ? 'UVM LaundryLink' : 'UVM LaundryLink'}</h1> 
                    </div>
                    <div className="flex items-center space-x-1 sm:space-x-2"> 
                      <button onClick={() => handleNavigate('settings', currentView === 'home' ? 'right' : (currentView === 'settings' ? '' : 'left'))} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-uvm-gold" title="Settings"> <Settings size={20} /> </button>
                      <button onClick={handleRefresh} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-uvm-gold" title="Refresh Data"> <RefreshCw size={20} className={(isLoadingRooms || isLoadingMachines || isBackgroundRefreshing) ? 'animate-spin' : ''} /> </button> 
                      <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 text-white hover:bg-white/20 rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-uvm-gold" title="Toggle Dark Mode"> {isDarkMode ? <Sun size={20} /> : <Moon size={20} />} </button> 
                    </div>
                  </div>
                </div>
              </header>

              <main className="container mx-auto p-4 sm:p-6 lg:p-8 overflow-x-hidden"> 
                <div 
                  key={currentView + selectedRoomId} 
                  className={`
                    ${animationDirection === 'left' ? 'animate-slideInFromLeft' : 
                      animationDirection === 'right' ? 'animate-slideInFromRight' : 
                      'opacity-100' 
                    }
                  `}
                  onAnimationEnd={() => setAnimationDirection('')} 
                >
                    {error && ( 
                      <div className="mb-6 p-4 bg-red-100 dark:bg-red-900/50 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-300 rounded-lg shadow-lg" role="alert"> 
                        <div className="flex items-center mb-2"> 
                          <AlertTriangle size={24} className="mr-3 text-red-500 dark:text-red-400 flex-shrink-0" /> 
                          <p className="font-semibold text-lg">Application Error</p> 
                        </div> 
                        <p className="text-sm break-words">{error}</p> 
                        <p className="text-xs mt-2 opacity-80">Tips: Ensure your Pi server & ngrok are running. Verify the ngrok URL in the app matches the one from your Pi. Try opening the ngrok URL directly in your browser. Check the browser's developer console (F12) for more details.</p> 
                      </div> 
                    )}
                    
                    {currentView === 'home' && ( 
                      <> 
                        <div className="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4"> 
                          <h2 className={`text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-uvm-green'}`}>All Laundry Rooms</h2>
                          <button 
                              onClick={() => setShowOnlyFavorites(!showOnlyFavorites)} 
                              className={`flex items-center px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-uvm-gold
                                          ${showOnlyFavorites 
                                            ? 'bg-uvm-gold text-uvm-green shadow-md hover:bg-opacity-90' 
                                            : `${isDarkMode ? 'bg-slate-700 hover:bg-slate-600' : 'bg-gray-200 hover:bg-gray-300'} text-uvm-green dark:text-slate-200`}`}
                          > 
                              <Star size={16} className="mr-2"/>
                              {showOnlyFavorites ? "Show All" : "Show Favorites"}
                          </button>
                        </div> 
                        {isLoadingRooms ? ( 
                          <div className="text-center py-10 text-gray-600 dark:text-gray-400"> 
                            <RefreshCw size={48} className="mx-auto animate-spin" style={{color: UVM_GREEN}} /> 
                            <p className="mt-2 text-lg">Loading Rooms...</p> 
                          </div> 
                        ) : displayedRooms.length === 0 ? ( 
                          <div className="text-center py-16 text-gray-500 dark:text-gray-400 bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"> 
                            <Info size={56} className="mx-auto opacity-70" /> 
                            <p className="mt-4 text-xl">{showOnlyFavorites && laundryRooms.length > 0 ? "No favorite rooms yet." : "No laundry rooms found."}</p> 
                            <p className="text-sm mt-1">{showOnlyFavorites && laundryRooms.length > 0 ? "Tap the star on a room card to add it to your favorites!" : "Please check your Raspberry Pi connection or ngrok setup. Ensure the server is running on the Pi."}</p>
                          </div> 
                        ) : ( 
                          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"> 
                            {displayedRooms.map(room => ( 
                              <RoomCard key={room.id} room={room} onSelectRoom={(id) => handleNavigate('roomDetail', 'right', id)} isFavorite={favorites.includes(room.id)} onToggleFavorite={toggleFavorite} /> 
                            ))} 
                          </div> 
                        )} 
                      </> 
                    )}
                    
                    {currentView === 'roomDetail' && ( 
                      <> 
                        <div className="flex flex-col sm:flex-row items-center justify-between mb-6 gap-3"> 
                          <button onClick={() => handleNavigate('home', 'left')} className={`flex items-center text-sm font-medium rounded-lg px-3 py-2 hover:bg-gray-200 dark:hover:bg-slate-700 ${isDarkMode ? 'text-white' : 'text-uvm-green'} transition-colors focus:outline-none focus:ring-2 focus:ring-uvm-gold`}> <ArrowLeft size={18} className="mr-2"/> Back </button> 
                          <h2 className={`text-2xl md:text-3xl font-bold text-center flex-1 sm:mx-4 truncate ${isDarkMode ? 'text-white' : 'text-uvm-green'}`} title={String(currentRoomName)}>{String(currentRoomName)}</h2> 
                          <div className="sm:w-auto hidden sm:block" style={{minWidth: '80px'}}> 
                             {currentRoomOfficialUrl && (
                                <a href={currentRoomOfficialUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center px-3 py-2 border border-transparent text-xs font-medium rounded-md shadow-sm text-white transition-colors duration-150 hover:opacity-80 whitespace-nowrap" style={{ backgroundColor: UVM_GREEN }} title="Visit Official Tracker"> 
                                <ExternalLink size={16} className="mr-1.5" /> 
                                Official Site
                                </a> 
                             )}
                          </div>
                        </div> 
                        
                        {currentRoomOfficialUrl && ( 
                          <div className="my-4 text-center sm:hidden"> 
                            <a href={currentRoomOfficialUrl} target="_blank" rel="noopener noreferrer" className="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white transition-colors duration-150 hover:opacity-80" style={{ backgroundColor: UVM_GREEN }} > 
                              <ExternalLink size={18} className="mr-2" /> 
                              Visit Official Tracker & Set Alerts
                            </a> 
                          </div> 
                        )}
                        
                        <div className="mb-6 p-4 sm:p-6 bg-white dark:bg-slate-800 rounded-xl shadow-xl"> 
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end"> 
                            <div> 
                              <label htmlFor="search" className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Search Machines</label> 
                              <input type="text" id="search" placeholder="e.g., Washer 13, Dryer, Large" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} className="w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-lg shadow-sm focus:ring-uvm-gold focus:border-uvm-gold dark:bg-slate-700 dark:text-white transition-colors" /> 
                            </div> 
                            <div> 
                              <label htmlFor="statusFilter" className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">Filter by Status</label> 
                              <select id="statusFilter" value={filterStatus} onChange={(e) => setFilterStatus(e.target.value)} className="w-full p-2.5 border border-gray-300 dark:border-slate-600 rounded-lg shadow-sm focus:ring-uvm-gold focus:border-uvm-gold dark:bg-slate-700 dark:text-white transition-colors"> 
                                {statusOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)} 
                              </select> 
                            </div> 
                          </div> 
                          <div className="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-gray-700 dark:text-slate-300">
                            <p>Washers: <span className="font-semibold text-uvm-green dark:text-uvm-gold">{availableWashersInRoom}</span> Available / <span className="font-semibold">{totalWashersInRoom}</span> Total</p>
                            <p>Dryers: <span className="font-semibold text-uvm-green dark:text-uvm-gold">{availableDryersInRoom}</span> Available / <span className="font-semibold">{totalDryersInRoom}</span> Total</p>
                          </div>
                          {lastUpdated && <p className="text-xs text-gray-500 dark:text-slate-400 mt-3 text-right">Last Updated: {lastUpdated.toLocaleTimeString()}</p>}
                        </div>

                        {isLoadingMachines && !isBackgroundRefreshing && machines.length === 0 ? ( 
                          <div className="text-center py-10 text-gray-600 dark:text-gray-400"> 
                            <RefreshCw size={48} className="mx-auto animate-spin" style={{color: UVM_GREEN}} /> 
                            <p className="mt-2 text-lg">Loading Machines for {currentRoomName}...</p> 
                          </div> 
                        ) : !isLoadingMachines && machines.length === 0 && !error ? ( 
                          <div className="text-center py-16 text-gray-500 dark:text-gray-400 bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"> 
                            <Info size={56} className="mx-auto opacity-70" /> 
                            <p className="mt-4 text-xl">No Machines Found</p>
                            <p className="text-sm mt-1">No machines currently reported for {currentRoomName}. Data might be temporarily unavailable.</p>
                          </div> 
                        ) : !isLoadingMachines && filteredMachines.length === 0 && machines.length > 0 && !error ? ( 
                          <div className="text-center py-16 text-gray-500 dark:text-gray-400 bg-white dark:bg-slate-800 rounded-xl shadow-md p-6"> 
                            <Filter size={56} className="mx-auto opacity-70" /> 
                            <p className="mt-4 text-xl">No Machines Match Filter</p>
                            <p className="text-sm mt-1">Try adjusting your search term or status filter for {currentRoomName}.</p>
                          </div> 
                        ) : ( 
                          <>
                            {totalWashersInRoom > 0 && (
                                <div className="mb-8">
                                    <h3 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-slate-200 border-b-2 border-uvm-gold pb-2">Washers</h3>
                                    {roomWashers.length > 0 ? (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6"> 
                                            {roomWashers.map(machine => ( 
                                            <MachineCard key={machine.id || String(machine.machineName) + String(machine.node) } machine={machine} onSetUpSmsAlert={handleOpenSmsModal} isSmsAlertSet={smsAlertsSet.includes(machine.id)} /> 
                                            ))} 
                                        </div>
                                    ) : ( <p className="text-gray-500 dark:text-gray-400 pl-1">No washers match your current filter.</p> )}
                                </div>
                            )}
                            {(totalWashersInRoom > 0 && roomWashers.length > 0 && totalDryersInRoom > 0 && roomDryers.length > 0) && ( <hr className="my-8 border-gray-300 dark:border-slate-600" /> )}
                            {totalDryersInRoom > 0 && (
                                <div>
                                    <h3 className="text-2xl font-semibold mb-4 text-gray-800 dark:text-slate-200 border-b-2 border-uvm-gold pb-2">Dryers</h3>
                                     {roomDryers.length > 0 ? (
                                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5 md:gap-6"> 
                                            {roomDryers.map(machine => ( 
                                            <MachineCard key={machine.id || String(machine.machineName) + String(machine.node) } machine={machine} onSetUpSmsAlert={handleOpenSmsModal} isSmsAlertSet={smsAlertsSet.includes(machine.id)} /> 
                                            ))} 
                                        </div>
                                     ) : ( <p className="text-gray-500 dark:text-gray-400 pl-1">No dryers match your current filter.</p> )}
                                </div>
                            )}
                          </>
                        )}
                      </> 
                    )}

                    {currentView === 'settings' && (
                      <div className="max-w-xl mx-auto bg-white dark:bg-slate-800 p-6 sm:p-8 rounded-xl shadow-xl">
                        <div className="flex items-center justify-between mb-6">
                            <h2 className={`text-2xl md:text-3xl font-bold ${isDarkMode ? 'text-white' : 'text-uvm-green'}`}>Settings</h2>
                            <button onClick={() => handleNavigate('home', 'left')} className={`flex items-center text-sm font-medium rounded-lg px-3 py-2 hover:bg-gray-200 dark:hover:bg-slate-700 ${isDarkMode ? 'text-white' : 'text-uvm-green'} transition-colors focus:outline-none focus:ring-2 focus:ring-uvm-gold`}> <ArrowLeft size={18} className="mr-2"/> Back to Home </button> 
                        </div>
                        <div className="space-y-6">
                            <div>
                                <label htmlFor="settingsPhoneNumber" className="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-1">
                                    Default Phone Number for SMS Alerts
                                </label>
                                <div className="mt-1 flex rounded-md shadow-sm">
                                    <span className="inline-flex items-center px-3 rounded-l-md border border-r-0 border-gray-300 dark:border-slate-600 bg-gray-50 dark:bg-slate-700 text-gray-500 dark:text-slate-400 text-sm">
                                        <Smartphone size={16} />
                                    </span>
                                    <input 
                                        type="tel" 
                                        id="settingsPhoneNumber" 
                                        name="settingsPhoneNumber"
                                        className="block w-full flex-1 rounded-none rounded-r-md p-2.5 border border-gray-300 dark:border-slate-600 focus:ring-uvm-gold focus:border-uvm-gold sm:text-sm dark:bg-slate-700 dark:text-white" 
                                        placeholder="10 digits, e.g., 8025551234"
                                        value={tempPhoneNumber}
                                        onChange={(e) => setTempPhoneNumber(e.target.value.replace(/\D/g, '').slice(0,10))}
                                        maxLength="10"
                                    />
                                </div>
                                {phoneNumber && tempPhoneNumber === phoneNumber && ( // Show currently saved only if temp is same or empty
                                     <p className="mt-2 text-xs text-gray-500 dark:text-slate-400">Currently saved: {phoneNumber.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3')}</p>
                                )}
                            </div>
                            <button 
                                onClick={handleSaveSettingsPhoneNumber}
                                className="w-full flex items-center justify-center px-4 py-2.5 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-900 focus:ring-uvm-gold"
                                style={{backgroundColor: UVM_GREEN}}
                                onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#0f3927'}
                                onMouseOut={(e) => e.currentTarget.style.backgroundColor = UVM_GREEN}
                            >
                                <Save size={18} className="mr-2" />
                                Save Phone Number
                            </button>
                        </div>
                      </div>
                    )}
                </div>
              </main>
              <footer className="mt-16 py-8 border-t border-gray-200 dark:border-slate-700 bg-gray-100 dark:bg-slate-800/50"> 
                <div className="container mx-auto px-4 sm:px-6 lg:px-8 text-center text-gray-500 dark:text-slate-400 text-sm"> 
                  <p>&copy; {new Date().getFullYear()} UVM LaundryLink.</p> 
                  <p className="mt-1">Created by Ivan Minier</p> 
                </div> 
              </footer>
              
              {showSmsModal && smsMachine && ( 
                <div className="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={() => setShowSmsModal(false)}>  
                  <div className="bg-white dark:bg-slate-800 p-6 rounded-xl shadow-2xl max-w-md w-full" onClick={(e) => e.stopPropagation()}> 
                    <div className="flex justify-between items-center mb-4"> 
                      <h3 className="text-xl font-semibold text-gray-800 dark:text-white">Set SMS Alert: <span className="text-uvm-green dark:text-uvm-gold">{String(smsMachine.machineName)}</span></h3> 
                      <button onClick={() => setShowSmsModal(false)} className="p-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-slate-700 text-gray-500 dark:text-gray-400 transition-colors"> <XCircle size={24} /> </button> 
                    </div> 
                    {/* Removed Pi reference and yellow text */}
                    <div className="mb-4"> 
                      <label htmlFor="modalPhoneNumber" className="block text-sm font-medium text-gray-700 dark:text-slate-300">Phone Number (10 digits):</label> 
                      <input 
                        type="tel" 
                        id="modalPhoneNumber" 
                        value={tempPhoneNumber} 
                        onChange={(e) => setTempPhoneNumber(e.target.value.replace(/\D/g, '').slice(0,10))} 
                        placeholder="e.g., 8025551234" 
                        className="mt-1 block w-full px-3 py-2.5 border border-gray-300 dark:border-slate-600 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-uvm-gold focus:border-uvm-gold sm:text-sm dark:bg-slate-700 dark:text-white transition-colors" 
                        maxLength="10" 
                      /> 
                    </div> 
                    {smsStatus.message && ( 
                      <p className={`text-sm my-3 p-3 rounded-lg 
                        ${smsStatus.type === 'error' ? 'bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 border border-red-300 dark:border-red-600' : 
                          smsStatus.type === 'success' ? 'bg-green-100 dark:bg-green-900/50 text-green-700 dark:text-green-300 border border-green-300 dark:border-green-600' : 
                          'bg-blue-100 dark:bg-blue-900/50 text-blue-700 dark:text-blue-300 border border-blue-300 dark:border-blue-600'}`}> 
                        {smsStatus.message} 
                      </p> 
                    )} 
                    <div className="mt-6 flex justify-end space-x-3"> 
                      <button onClick={() => setShowSmsModal(false)} className="px-4 py-2 rounded-lg text-gray-700 dark:text-slate-200 bg-gray-200 dark:bg-slate-600 hover:bg-gray-300 dark:hover:bg-slate-500 transition-colors focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button> 
                      <button 
                        onClick={handleSendSmsAlert} 
                        className="px-4 py-2 rounded-lg text-white font-medium transition-colors flex items-center justify-center focus:outline-none focus:ring-2 focus:ring-offset-2 dark:focus:ring-offset-slate-800 focus:ring-uvm-gold" 
                        style={{backgroundColor: UVM_GREEN}} 
                        onMouseOver={(e) => e.currentTarget.style.backgroundColor = '#0f3927'} 
                        onMouseOut={(e) => e.currentTarget.style.backgroundColor = UVM_GREEN}
                        disabled={smsStatus.type === "info"} 
                      > 
                        {smsStatus.type === "info" ? <RefreshCw size={18} className="animate-spin mr-2" /> : null}
                        Set SMS Alert 
                      </button> 
                    </div> 
                  </div> 
                </div> 
              )}
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
